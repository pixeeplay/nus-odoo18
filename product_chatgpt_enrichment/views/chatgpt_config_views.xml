<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="action_chatgpt_model" model="ir.actions.act_window">
            <field name="name">AI Models</field>
            <field name="res_model">chatgpt.model</field>
            <field name="view_mode">list,form</field>
        </record>

        <!-- Action for ChatGPT Configuration -->
        <record id="action_chatgpt_config" model="ir.actions.act_window">
            <field name="name">ChatGPT Configuration</field>
            <field name="res_model">chatgpt.config</field>
            <field name="view_mode">list,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Configure ChatGPT API Settings
                </p>
                <p>
                    Set up your OpenAI API key and preferences for automatic product enrichment.
                </p>
            </field>
        </record>

        <!-- Action for All Products -->
        <record id="action_ai_products_all" model="ir.actions.act_window">
            <field name="name">All Products</field>
            <field name="res_model">product.template</field>
            <field name="view_mode">list,form,kanban</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Manage your products and enrich them with AI
                </p>
            </field>
        </record>

        <!-- Action for Enriched Products Only -->
        <record id="action_ai_products_enriched" model="ir.actions.act_window">
            <field name="name">Enriched Products</field>
            <field name="res_model">product.template</field>
            <field name="view_mode">list,form,kanban</field>
            <field name="domain">[('chatgpt_enriched', '=', True)]</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Products already enriched by AI
                </p>
            </field>
        </record>

        <!-- Action for Prompts -->
        <record id="action_chatgpt_prompt" model="ir.actions.act_window">
            <field name="name">AI Prompts</field>
            <field name="res_model">chatgpt.product.prompt</field>
            <field name="view_mode">list,form</field>
        </record>

        <!-- Root Menu (App on Home Screen) -->
        <menuitem id="menu_ai_enrichment_root"
                  name="AI Enrichment"
                  web_icon="product_chatgpt_enrichment,static/description/icon.png"
                  sequence="100"/>

        <!-- Products Menu Section -->
        <menuitem id="menu_ai_products"
                  name="Products"
                  parent="menu_ai_enrichment_root"
                  sequence="10"/>

        <menuitem id="menu_ai_products_all"
                  name="All Products"
                  parent="menu_ai_products"
                  action="action_ai_products_all"
                  sequence="10"/>

        <menuitem id="menu_ai_products_enriched"
                  name="Enriched Products"
                  parent="menu_ai_products"
                  action="action_ai_products_enriched"
                  sequence="20"/>

        <!-- Configuration Menu Section -->
        <menuitem id="menu_ai_config_root"
                  name="Settings"
                  parent="menu_ai_enrichment_root"
                  sequence="100"/>

        <menuitem id="menu_ai_config"
                  name="AI Providers"
                  parent="menu_ai_config_root"
                  action="action_chatgpt_config"
                  sequence="10"/>

        <menuitem id="menu_ai_prompt"
                  name="AI Prompts"
                  parent="menu_ai_config_root"
                  action="action_chatgpt_prompt"
                  sequence="20"/>

        <menuitem id="menu_chatgpt_model"
                  name="AI Models"
                  parent="menu_ai_config_root"
                  action="action_chatgpt_model"
                  sequence="30"/>

        <!-- Tree View -->
        <record id="view_chatgpt_config_tree" model="ir.ui.view">
            <field name="name">chatgpt.config.tree</field>
            <field name="model">chatgpt.config</field>
            <field name="arch" type="xml">
                <list string="AI Configurations"
                      decoration-bf="is_default"
                      decoration-success="is_default">
                    <field name="is_default" widget="boolean_toggle" string="Default"/>
                    <field name="name"/>
                    <field name="provider" widget="badge"
                           decoration-info="provider in ['openai', 'anthropic']"
                           decoration-success="provider in ['ollama', 'llamacpp']"
                           decoration-warning="provider == 'perplexity'"
                           decoration-danger="provider == 'gemini'"/>
                    <field name="base_url" optional="show"/>
                    <field name="model_id"/>
                    <field name="ai_model_name" optional="hide"/>
                    <field name="auto_enrich"/>
                    <field name="active"/>
                </list>
            </field>
        </record>

        <!-- Form View -->
        <record id="view_chatgpt_config_form" model="ir.ui.view">
            <field name="name">chatgpt.config.form</field>
            <field name="model">chatgpt.config</field>
            <field name="arch" type="xml">
                <form string="AI Configuration">
                    <header>
                        <button name="action_test_connection"
                                string="Test Connection"
                                type="object"
                                class="btn-primary"
                                help="Test the connection to the selected AI provider"/>
                        <button name="action_discover_models"
                                string="Discover Models"
                                type="object"
                                help="Fetch available models from the provider"/>
                        <button name="action_set_default"
                                string="Set as Default"
                                type="object"
                                class="btn-success"
                                invisible="is_default"
                                help="Use this configuration as the default for product enrichment"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <widget name="web_ribbon" title="Archived" bg_color="text-bg-danger" invisible="active"/>
                            <widget name="web_ribbon" title="Default" bg_color="text-bg-success" invisible="not is_default"/>
                        </div>
                        <div class="oe_title">
                            <h1><field name="name" placeholder="Main AI Configuration"/></h1>
                        </div>
                        <group>
                            <group string="Provider Settings">
                                <field name="provider"/>

                                <!-- API Key: always show for cloud, show for Ollama only if web search or user typed one -->
                                <field name="api_key" password="True"
                                       invisible="provider in ['ollama', 'llamacpp'] and not ollama_web_search and not api_key"/>

                                <!-- Base URL: visible for ALL providers -->
                                <field name="base_url"
                                       placeholder="Auto-detected from provider"/>

                                <!-- Ollama-specific settings -->
                                <field name="ollama_api_mode"
                                       invisible="provider != 'ollama'"/>
                                <field name="ollama_web_search" widget="boolean_toggle"
                                       invisible="provider != 'ollama'"/>
                                <field name="ollama_cloud_key" password="True"
                                       invisible="provider != 'ollama' or not ollama_web_search"
                                       placeholder="sk-... (from ollama.com/settings/keys)"/>

                                <!-- API Endpoint: advanced, visible for local providers -->
                                <field name="api_endpoint"
                                       invisible="provider not in ['ollama', 'llamacpp']"/>

                                <!-- Model selection -->
                                <field name="model_id"
                                       domain="[('provider', '=', provider)]"
                                       options="{'no_create': True}"/>
                                <field name="ai_model_name"
                                       invisible="model_id"
                                       placeholder="e.g. llama3.2, gpt-4o-mini"/>
                            </group>
                            <group string="Behavior">
                                <field name="auto_enrich"/>
                                <field name="use_web_search"/>
                                <field name="use_deep_enrichment"/>
                                <field name="searxng_enabled" widget="boolean_toggle"/>
                                <field name="media_discovery"/>
                                <field name="max_tokens"/>
                                <field name="temperature"/>
                                <field name="active"/>
                            </group>
                        </group>

                        <!-- Provider-specific help banners -->
                        <div class="alert alert-light border mt-2 mb-2" role="alert"
                             invisible="provider != 'ollama'">
                            <strong>Ollama</strong><br/>
                            <strong>Base URL</strong> (appels IA) :
                            Local <code>http://localhost:11434</code> |
                            Mac Mini <code>http://192.168.x.x:11434</code><br/>
                            <small class="text-muted">
                                Assurez-vous que Ollama tourne (<code>ollama serve</code>
                                ou <code>OLLAMA_HOST=0.0.0.0 ollama serve</code> pour le r&#233;seau).
                            </small><br/>
                            <span invisible="not ollama_web_search">
                                <strong>Web Search</strong> (cloud, en parall&#232;le) :
                                Les recherches web passent par <code>ollama.com/api/web_search</code> avec votre cl&#233; cloud.<br/>
                                <small class="text-muted">
                                    Cl&#233; API cloud &#224; r&#233;cup&#233;rer sur
                                    <a href="https://ollama.com/settings/keys" target="_blank">ollama.com/settings/keys</a>.
                                    L'IA locale et le web search cloud fonctionnent ensemble.
                                </small>
                            </span>
                        </div>
                        <div class="alert alert-light border mt-2 mb-2" role="alert"
                             invisible="provider != 'llamacpp'">
                            <strong>Llama.cpp</strong> &amp;mdash;
                            Default: <code>http://localhost:8080</code> |
                            Remote: <code>http://192.168.x.x:8080</code><br/>
                            <small class="text-muted">
                                Start with: <code>llama-server -m model.gguf --port 8080 --host 0.0.0.0</code>
                            </small>
                        </div>

                        <!-- Last test result -->
                        <group invisible="not last_test_result">
                            <field name="last_test_result" readonly="1" nolabel="1"
                                   widget="text" class="text-muted"/>
                        </group>

                        <group string="Market Analysis &amp; Price Alignment" invisible="not use_deep_enrichment and not use_web_search">
                            <group>
                                <field name="price_alignment_strategy" widget="radio"/>
                                <field name="price_alignment_offset_type" widget="radio" invisible="price_alignment_strategy == 'none'"/>
                                <field name="price_alignment_offset" invisible="price_alignment_strategy == 'none' or price_alignment_offset_type != 'fixed'"/>
                                <field name="price_alignment_offset_pct" invisible="price_alignment_strategy == 'none' or price_alignment_offset_type != 'percentage'"/>
                            </group>
                            <group>
                                <field name="auto_enrich_enabled" widget="boolean_toggle"/>
                                <field name="auto_enrich_interval" invisible="not auto_enrich_enabled"/>
                                <field name="target_competitors" invisible="not use_deep_enrichment"/>
                                <field name="serpapi_key" password="True" required="use_deep_enrichment" invisible="not use_deep_enrichment"/>
                                <field name="scrapingbee_key" password="True" required="use_deep_enrichment" invisible="not use_deep_enrichment"/>
                            </group>
                        </group>
                        <group string="Advanced Search &amp; Scraping Controls" invisible="not use_deep_enrichment and not use_web_search">
                            <group>
                                <field name="serpapi_hl" placeholder="e.g. fr"/>
                                <field name="serpapi_gl" placeholder="e.g. fr"/>
                            </group>
                            <group>
                                <field name="max_scrape_pages"/>
                                <field name="debug_show_raw_results" widget="boolean_toggle"/>
                            </group>
                        </group>
                        <!-- SearXNG Configuration -->
                        <group string="SearXNG (Self-Hosted Web Search)" invisible="not searxng_enabled">
                            <group>
                                <field name="searxng_base_url" placeholder="http://searxng:8080"/>
                                <field name="searxng_engines" placeholder="google,duckduckgo,amazon"/>
                                <field name="searxng_language" placeholder="fr-FR"/>
                            </group>
                            <group>
                                <field name="searxng_max_results"/>
                                <field name="searxng_timeout"/>
                                <field name="searxng_delay"/>
                            </group>
                        </group>
                        <div class="mt-2 mb-2" invisible="not searxng_enabled">
                            <button name="action_test_searxng"
                                    string="Test SearXNG"
                                    type="object"
                                    class="btn-primary"
                                    icon="fa-search"/>
                        </div>
                        <div class="alert alert-light border mt-2 mb-2" role="alert"
                             invisible="not searxng_enabled">
                            <strong>SearXNG</strong> &#8212; Moteur de recherche auto-h&#233;berg&#233; (gratuit, pas de cl&#233; API).<br/>
                            <small class="text-muted">
                                Docker (m&#234;me r&#233;seau) : <code>http://searxng:8080</code> |
                                Externe : <code>http://IP:8888</code><br/>
                                SearXNG doit avoir <code>format: json</code> activ&#233; dans <code>settings.yml</code>.
                            </small>
                        </div>

                        <!-- Enrichment Pipeline Configuration -->
                        <group string="Enrichment Pipeline (Queue)" invisible="not searxng_enabled">
                            <group>
                                <field name="enrichment_batch_size_collect"/>
                                <field name="enrichment_batch_size_enrich"/>
                            </group>
                            <group>
                                <field name="enrichment_auto_publish" widget="boolean_toggle"/>
                                <field name="enrichment_overwrite_existing" widget="boolean_toggle"
                                       invisible="not enrichment_auto_publish"/>
                            </group>
                        </group>

                        <!-- Field Mapping Reference -->
                        <div invisible="not searxng_enabled" class="mt-3 mb-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-exchange me-2"/>Mapping des champs (IA → Odoo)</h5>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Clé JSON (réponse IA)</th>
                                                <th>Champ Odoo (ai_*)</th>
                                                <th>Auto-publish → champ standard</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td><code>titre_seo</code></td><td>ai_seo_title</td><td>website_meta_title</td></tr>
                                            <tr><td><code>meta_description</code></td><td>ai_meta_description</td><td>website_meta_description</td></tr>
                                            <tr><td><code>description_courte</code></td><td>ai_short_description</td><td>description_sale</td></tr>
                                            <tr><td><code>description_longue_html</code></td><td>ai_description_html</td><td>website_description</td></tr>
                                            <tr><td><code>bullet_points</code></td><td>ai_bullet_points</td><td>—</td></tr>
                                            <tr><td><code>tags</code></td><td>ai_tags</td><td>—</td></tr>
                                            <tr><td><code>arguments_vente</code></td><td>ai_selling_points</td><td>—</td></tr>
                                            <tr><td><code>categorie_suggeree</code></td><td>ai_suggested_category</td><td>—</td></tr>
                                            <tr><td><code>marque_detectee</code></td><td>ai_detected_brand</td><td>—</td></tr>
                                            <tr><td><code>public_cible</code></td><td>ai_target_audience</td><td>—</td></tr>
                                            <tr><td><code>specs_techniques</code></td><td>ai_technical_specs</td><td>—</td></tr>
                                            <tr><td><code>poids_estime_kg</code></td><td>ai_estimated_weight</td><td>—</td></tr>
                                            <tr><td><code>confiance</code></td><td>ai_confidence</td><td>—</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="card-footer text-muted small">
                                    <i class="fa fa-info-circle me-1"/>
                                    Si <b>Auto-publish</b> est activé, les champs avec une cible standard
                                    seront copiés automatiquement quand la confiance est "high" ou "medium".
                                    Sinon, utilisez le bouton "Appliquer aux champs standards" sur la fiche produit.
                                </div>
                            </div>
                        </div>

                        <notebook>
                            <page string="Prompts" name="prompts">
                                <group string="SearXNG + Ollama Pipeline Prompt" invisible="not searxng_enabled">
                                    <field name="enrichment_prompt_template" nolabel="1"
                                           placeholder="Template for the queue-based enrichment pipeline..."/>
                                </group>
                                <group string="Custom Step Prompts">
                                    <field name="prompt_technical_research"/>
                                    <field name="prompt_deep_enrichment"/>
                                </group>
                                <field name="prompt_ids">
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="name"/>
                                        <field name="language"/>
                                        <field name="target_field_id"/>
                                        <field name="prompt_template"/>
                                        <field name="active"/>
                                    </list>
                                </field>
                            </page>
                            <page string="Detailed Guide" name="guide">
                                <div class="alert alert-light border shadow-sm p-4" role="alert">
                                    <h4 class="alert-heading text-primary"><i class="fa fa-graduation-cap mr-2"/> Detailed User Guide</h4>
                                    <div class="row">
                                        <!-- content... -->
                                    </div>
                                </div>
                            </page>
                            <page string="Discovery Stats" name="discovery" invisible="not model_discovery_results">
                                <group>
                                    <field name="model_discovery_results" nolabel="1"/>
                                </group>
                            </page>
                        </notebook>
                        <div class="alert alert-info" role="alert">
                            <strong>Note:</strong> Use <code>{product_name}</code> in your prompt templates as a placeholder for the product name.
                        </div>
                    </sheet>
                </form>
            </field>
        </record>

</odoo>
