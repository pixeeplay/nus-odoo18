<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Server Action: Process Queue Now (must be before list view that references it) -->
    <record id="action_process_queue_now" model="ir.actions.server">
        <field name="name">Traiter la file maintenant</field>
        <field name="model_id" ref="model_product_enrichment_queue"/>
        <field name="state">code</field>
        <field name="code">model.action_process_queue_now()</field>
    </record>

    <!-- List View -->
    <record id="view_product_enrichment_queue_list" model="ir.ui.view">
        <field name="name">product.enrichment.queue.list</field>
        <field name="model">product.enrichment.queue</field>
        <field name="arch" type="xml">
            <list string="File d'attente enrichissement IA"
                  decoration-danger="state in ('error', 'skipped')"
                  decoration-success="state == 'done'"
                  decoration-warning="state in ('collecting', 'enriching')"
                  decoration-info="state == 'collected'">
                <header>
                    <button name="%(action_process_queue_now)d"
                            string="Traiter maintenant"
                            type="action"
                            class="btn-primary"
                            icon="fa-play"/>
                </header>
                <field name="product_id"/>
                <field name="state" widget="badge"
                       decoration-info="state in ('pending', 'collected')"
                       decoration-warning="state in ('collecting', 'enriching')"
                       decoration-success="state == 'done'"
                       decoration-danger="state in ('error', 'skipped')"/>
                <field name="priority"/>
                <field name="parsed_confidence" optional="show"/>
                <field name="parsed_brand" optional="show"/>
                <field name="web_result_count" optional="show" string="Web"/>
                <field name="processing_time_search" optional="show" string="Search (s)"/>
                <field name="processing_time_ollama" optional="show" string="AI (s)"/>
                <field name="date_queued"/>
                <field name="date_enriched" optional="show"/>
                <field name="error_message" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_product_enrichment_queue_form" model="ir.ui.view">
        <field name="name">product.enrichment.queue.form</field>
        <field name="model">product.enrichment.queue</field>
        <field name="arch" type="xml">
            <form string="Enrichment Queue Item">
                <header>
                    <button name="action_retry" string="Relancer"
                            type="object" class="btn-primary"
                            invisible="state not in ('error', 'skipped')"
                            icon="fa-refresh"/>
                    <button name="action_reset" string="Réinitialiser"
                            type="object" class="btn-secondary"
                            icon="fa-undo"/>
                    <button name="action_force_done" string="Forcer terminé"
                            type="object" class="btn-warning"
                            invisible="state == 'done'"
                            icon="fa-check"/>
                    <field name="state" widget="statusbar"
                           statusbar_visible="pending,collected,done"/>
                </header>
                <sheet>
                    <!-- Summary banner for done items -->
                    <div class="alert alert-success d-flex align-items-center"
                         invisible="state != 'done'">
                        <i class="fa fa-check-circle fa-2x me-3"/>
                        <div>
                            <strong>Enrichissement terminé</strong>
                            <div class="d-flex gap-3 mt-1">
                                <span><i class="fa fa-search me-1"/>
                                    <field name="web_result_count" class="d-inline"/> résultats web</span>
                                <span><i class="fa fa-clock-o me-1"/>
                                    Recherche: <field name="processing_time_search" class="d-inline"/>s
                                    | IA: <field name="processing_time_ollama" class="d-inline"/>s</span>
                                <span><i class="fa fa-shield me-1"/>
                                    Confiance: <field name="parsed_confidence" class="d-inline fw-bold"/></span>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-danger" invisible="state not in ('error', 'skipped')">
                        <strong><i class="fa fa-exclamation-triangle me-1"/>Erreur :</strong>
                        <field name="error_message" nolabel="1" readonly="1"/>
                    </div>

                    <group>
                        <group string="Produit">
                            <field name="product_id"/>
                            <field name="priority"/>
                            <field name="search_query_used" readonly="1"/>
                            <field name="attempt_count" readonly="1"/>
                            <field name="max_attempts"/>
                        </group>
                        <group string="Résumé IA" invisible="state != 'done'">
                            <field name="parsed_seo_title" readonly="1"/>
                            <field name="parsed_brand" readonly="1"/>
                            <field name="parsed_category" readonly="1"/>
                            <field name="parsed_confidence" readonly="1"/>
                            <field name="date_enriched" readonly="1"/>
                        </group>
                        <group string="Timing" invisible="state == 'done'">
                            <field name="date_queued" readonly="1"/>
                            <field name="date_collected" readonly="1"/>
                            <field name="date_enriched" readonly="1"/>
                            <field name="processing_time_search" readonly="1"/>
                            <field name="processing_time_ollama" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <!-- Tab 1: Enriched Data (formatted) -->
                        <page string="Données enrichies" name="enriched_view"
                              invisible="not enriched_data">
                            <field name="enriched_data_html" nolabel="1" readonly="1"/>
                        </page>

                        <!-- Tab 2: Web Data (formatted) -->
                        <page string="Données web (SearXNG)" name="web_data">
                            <div invisible="not raw_web_data">
                                <div class="mb-2">
                                    <strong><i class="fa fa-search me-1"/>Requête :</strong>
                                    <field name="search_query_used" class="d-inline" readonly="1"/>
                                    <span class="ms-3 badge text-bg-info">
                                        <field name="web_result_count" class="d-inline"/> résultats
                                    </span>
                                </div>
                                <field name="web_data_html" nolabel="1" readonly="1"/>
                            </div>
                            <div invisible="raw_web_data" class="text-muted p-4 text-center">
                                <i class="fa fa-spinner fa-spin fa-2x mb-2"/><br/>
                                Les résultats SearXNG apparaîtront ici après la phase de collecte...
                            </div>
                        </page>

                        <!-- Tab 3: Raw data (debug) -->
                        <page string="Données brutes (debug)" name="raw_data">
                            <group string="Réponse brute Ollama">
                                <field name="raw_ollama_response" nolabel="1" readonly="1"
                                       widget="text"/>
                            </group>
                            <group string="JSON enrichi (parsé)">
                                <field name="enriched_data" nolabel="1" readonly="1"
                                       widget="text"/>
                            </group>
                            <group string="JSON web brut">
                                <field name="raw_web_data" nolabel="1" readonly="1"
                                       widget="text"/>
                            </group>
                            <group string="Timing détaillé">
                                <field name="date_queued" readonly="1"/>
                                <field name="date_collected" readonly="1"/>
                                <field name="date_enriched" readonly="1"/>
                                <field name="processing_time_search" readonly="1"/>
                                <field name="processing_time_ollama" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_product_enrichment_queue_search" model="ir.ui.view">
        <field name="name">product.enrichment.queue.search</field>
        <field name="model">product.enrichment.queue</field>
        <field name="arch" type="xml">
            <search string="Queue">
                <field name="product_id"/>
                <field name="state"/>
                <field name="error_message"/>
                <filter name="pending" string="En attente" domain="[('state', '=', 'pending')]"/>
                <filter name="collecting" string="Collecte" domain="[('state', '=', 'collecting')]"/>
                <filter name="collected" string="Collecté" domain="[('state', '=', 'collected')]"/>
                <filter name="enriching" string="Enrichissement" domain="[('state', '=', 'enriching')]"/>
                <filter name="done" string="Terminé" domain="[('state', '=', 'done')]"/>
                <filter name="error" string="Erreur" domain="[('state', 'in', ('error', 'skipped'))]"/>
                <separator/>
                <filter name="high_priority" string="Priorité haute" domain="[('priority', '=', '2')]"/>
                <separator/>
                <filter name="today" string="Aujourd'hui" domain="[('date_queued', '>=', (context_today()).strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="Group By">
                    <filter name="group_state" string="État" context="{'group_by': 'state'}"/>
                    <filter name="group_priority" string="Priorité" context="{'group_by': 'priority'}"/>
                    <filter name="group_date" string="Date" context="{'group_by': 'date_queued:day'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Graph View (Dashboard) -->
    <record id="view_product_enrichment_queue_graph" model="ir.ui.view">
        <field name="name">product.enrichment.queue.graph</field>
        <field name="model">product.enrichment.queue</field>
        <field name="arch" type="xml">
            <graph string="Enrichissement IA — Statistiques" type="bar">
                <field name="state" type="col"/>
            </graph>
        </field>
    </record>

    <!-- Pivot View (Dashboard) -->
    <record id="view_product_enrichment_queue_pivot" model="ir.ui.view">
        <field name="name">product.enrichment.queue.pivot</field>
        <field name="model">product.enrichment.queue</field>
        <field name="arch" type="xml">
            <pivot string="Enrichissement IA — Tableau croisé">
                <field name="state" type="col"/>
                <field name="date_queued" interval="day" type="row"/>
            </pivot>
        </field>
    </record>

    <!-- Action: Queue List -->
    <record id="action_product_enrichment_queue" model="ir.actions.act_window">
        <field name="name">File d'attente enrichissement</field>
        <field name="res_model">product.enrichment.queue</field>
        <field name="view_mode">list,form,graph,pivot</field>
        <field name="search_view_id" ref="view_product_enrichment_queue_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Aucun produit dans la file d'attente
            </p>
            <p>
                Ajoutez des produits via le bouton "Enrichir (Queue IA)" ou le wizard batch.
            </p>
        </field>
    </record>

    <!-- Action: Dashboard -->
    <record id="action_product_enrichment_dashboard" model="ir.actions.act_window">
        <field name="name">Dashboard enrichissement</field>
        <field name="res_model">product.enrichment.queue</field>
        <field name="view_mode">graph,pivot,list</field>
        <field name="search_view_id" ref="view_product_enrichment_queue_search"/>
    </record>

</odoo>
