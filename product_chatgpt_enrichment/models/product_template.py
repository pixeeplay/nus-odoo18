# -*- coding: utf-8 -*-
from odoo import models, fields, api, _
from odoo.exceptions import UserError
import logging

_logger = logging.getLogger(__name__)


class ProductTemplate(models.Model):
    _inherit = 'product.template'

    chatgpt_enriched = fields.Boolean(
        string='Enriched by ChatGPT',
        default=False,
        readonly=True,
        help='Indicates if this product has been enriched by ChatGPT'
    )
    
    chatgpt_content = fields.Html(
        string='AI Generated Content',
        readonly=True,
        help='Content generated by ChatGPT'
    )
    
    chatgpt_last_enrichment = fields.Datetime(
        string='Last Enrichment Date',
        readonly=True,
        help='Date and time of last ChatGPT enrichment'
    )

    @api.model_create_multi
    def create(self, vals_list):
        """Override create to auto-enrich products if enabled"""
        records = super(ProductTemplate, self).create(vals_list)
        
        # Check if auto-enrichment is enabled
        try:
            config = self.env['chatgpt.config'].get_active_config()
            if config.auto_enrich:
                for record in records:
                    if record.name and not record.chatgpt_enriched:
                        try:
                            record._enrich_with_chatgpt()
                        except Exception as e:
                            _logger.warning('Auto-enrichment failed for product %s: %s', record.name, str(e))
                            # Don't block product creation if enrichment fails
        except Exception as e:
            _logger.warning('Could not check auto-enrich config: %s', str(e))
            
        return records

    def action_enrich_with_chatgpt(self):
        """Manual action to enrich product with ChatGPT"""
        self.ensure_one()
        
        if not self.name:
            raise UserError(_('Product must have a name before enrichment.'))
        
        self._enrich_with_chatgpt()
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('Product enriched successfully with ChatGPT!'),
                'type': 'success',
                'sticky': False,
            }
        }

    def _enrich_with_chatgpt(self):
        """Internal method to enrich product using ChatGPT"""
        self.ensure_one()
        
        # Get active configuration
        config = self.env['chatgpt.config'].get_active_config()
        
        # Prepare the prompt
        prompt = config.prompt_template.format(product_name=self.name)
        
        _logger.info('Enriching product: %s', self.name)
        
        # Call ChatGPT API
        enriched_content = config.call_chatgpt_api(prompt)
        
        # Update product with enriched content
        vals = {
            'chatgpt_content': enriched_content,
            'chatgpt_enriched': True,
            'chatgpt_last_enrichment': fields.Datetime.now(),
        }
        
        # Map to standard Odoo fields if they exist
        if 'description_sale' in self._fields:
            vals['description_sale'] = enriched_content
        if 'description' in self._fields:
            vals['description'] = enriched_content
        if 'website_description' in self._fields:
            vals['website_description'] = enriched_content
            
        self.write(vals)
        
        _logger.info('Product %s enriched successfully', self.name)

    def action_clear_enrichment(self):
        """Clear ChatGPT enrichment data"""
        self.ensure_one()
        vals = {
            'chatgpt_enriched': False,
            'chatgpt_content': False,
            'chatgpt_last_enrichment': False,
        }
        if 'description_sale' in self._fields:
            vals['description_sale'] = False
        if 'description' in self._fields:
            vals['description'] = False
        if 'website_description' in self._fields:
            vals['website_description'] = False
            
        self.write(vals)
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('ChatGPT enrichment data cleared.'),
                'type': 'info',
                'sticky': False,
            }
        }

    def action_view_chatgpt_enrichment(self):
        """Dummy action for stat button to satisfy Odoo requirements"""
        return True
