<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================
         Extend product.template form: add PrestaShop tab
         ============================================================ -->
    <record id="view_product_template_form_prestashop" model="ir.ui.view">
        <field name="name">product.template.form.prestashop</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_only_form_view"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                <page name="prestashop" string="PrestaShop">
                    <div class="mb-3">
                        <button name="action_open_reimport_wizard"
                                string="Re-sync from PrestaShop"
                                type="object"
                                class="btn-primary me-2"
                                icon="fa-refresh"
                                invisible="not prestashop_id"/>
                        <button name="action_export_to_prestashop"
                                string="Export to PrestaShop"
                                type="object"
                                class="btn-success me-2"
                                icon="fa-upload"/>
                    </div>
                    <!-- Export Configuration -->
                    <group string="Export to PrestaShop">
                        <group>
                            <field name="ps_export_enabled"/>
                            <field name="ps_export_state" readonly="1" widget="badge"
                                   decoration-success="ps_export_state == 'exported'"
                                   decoration-warning="ps_export_state == 'modified'"
                                   decoration-danger="ps_export_state == 'error'"
                                   decoration-muted="ps_export_state == 'not_exported'"/>
                            <field name="ps_last_export" readonly="1"/>
                        </group>
                        <group>
                            <field name="ps_stock_location_id"/>
                            <field name="ps_export_price_type"/>
                            <field name="ps_export_pricelist_id"
                                   invisible="ps_export_price_type != 'pricelist'"/>
                        </group>
                    </group>
                    <group string="Export Error" invisible="not ps_export_error">
                        <field name="ps_export_error" readonly="1" nolabel="1" colspan="2"/>
                    </group>
                    <group>
                        <group string="PrestaShop Info">
                            <field name="prestashop_id" readonly="1"/>
                            <field name="prestashop_instance_id" readonly="1"/>
                            <field name="prestashop_url" readonly="1" widget="url"/>
                            <field name="prestashop_last_sync" readonly="1"/>
                            <field name="prestashop_manufacturer" readonly="1"/>
                            <field name="prestashop_ean13" readonly="1"/>
                            <field name="prestashop_active" readonly="1"/>
                        </group>
                        <group string="Taxes &amp; Eco-Tax">
                            <field name="prestashop_ecotax" readonly="1"/>
                            <field name="prestashop_tax_rules_group_id" readonly="1"/>
                            <field name="prestashop_tax_rate" readonly="1"/>
                            <field name="prestashop_tax_id"/>
                        </group>
                        <group string="SEO">
                            <field name="prestashop_meta_title" readonly="1"/>
                            <field name="prestashop_meta_description" readonly="1"/>
                        </group>
                    </group>
                    <group string="Full Description (HTML)">
                        <field name="prestashop_description_html" readonly="1" nolabel="1"/>
                    </group>
                    <group string="Short Description (HTML)">
                        <field name="prestashop_description_short_html" readonly="1" nolabel="1"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- ============================================================
         Product list: add PS columns
         ============================================================ -->
    <record id="view_product_template_tree_prestashop" model="ir.ui.view">
        <field name="name">product.template.list.prestashop</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_tree_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='default_code']" position="after">
                <field name="prestashop_id" string="PS ID" optional="hide"/>
                <field name="prestashop_active" string="Active PS" optional="hide"/>
                <field name="prestashop_manufacturer" string="PS Manufacturer" optional="hide"/>
                <field name="ps_export_enabled" string="PS Export" widget="boolean" optional="hide"/>
                <field name="ps_export_state" string="Export Status" widget="badge" optional="hide"
                       decoration-success="ps_export_state == 'exported'"
                       decoration-warning="ps_export_state == 'modified'"
                       decoration-danger="ps_export_state == 'error'"
                       decoration-muted="ps_export_state == 'not_exported'"/>
            </xpath>
        </field>
    </record>

    <!-- ============================================================
         Search view: filter / group by PrestaShop
         ============================================================ -->
    <record id="view_product_template_search_prestashop" model="ir.ui.view">
        <field name="name">product.template.search.prestashop</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <filter name="filter_prestashop"
                        string="PrestaShop Products"
                        domain="[('prestashop_instance_id', '!=', False)]"/>
                <filter name="filter_prestashop_active"
                        string="Active in PS"
                        domain="[('prestashop_active', '=', True), ('prestashop_instance_id', '!=', False)]"/>
                <filter name="filter_prestashop_inactive"
                        string="Inactive in PS"
                        domain="[('prestashop_active', '=', False), ('prestashop_instance_id', '!=', False)]"/>
                <separator/>
                <filter name="filter_export_enabled"
                        string="Export Enabled"
                        domain="[('ps_export_enabled', '=', True)]"/>
                <filter name="filter_export_modified"
                        string="Modified (needs re-export)"
                        domain="[('ps_export_state', '=', 'modified')]"/>
                <filter name="filter_export_errors"
                        string="Export Errors"
                        domain="[('ps_export_state', '=', 'error')]"/>
                <group expand="0" string="Group By">
                    <filter name="group_by_instance"
                            string="PS Instance"
                            context="{'group_by': 'prestashop_instance_id'}"/>
                    <filter name="group_by_manufacturer"
                            string="PS Manufacturer"
                            context="{'group_by': 'prestashop_manufacturer'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- ============================================================
         Server actions: multi-select from product list view
         ============================================================ -->
    <record id="action_export_selected_to_prestashop" model="ir.actions.server">
        <field name="name">Exporter vers PrestaShop</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="binding_model_id" ref="product.model_product_template"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    action = records.action_export_to_prestashop()
        </field>
    </record>

    <record id="action_mark_selected_for_export" model="ir.actions.server">
        <field name="name">Marquer pour export PS</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="binding_model_id" ref="product.model_product_template"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    records.action_mark_for_export()
        </field>
    </record>

</odoo>
